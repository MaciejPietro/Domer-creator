import{i as p,r as m,F as w,E as y,e as T,C as D}from"./index-U9Uyws7Y.js";import"./webworkerAll-jlsikzaB.js";import"./colorToUniform-D097EnAu.js";import"./CanvasPool-Betj7H66.js";import"./batchSamplersUniformGroup-PeBTdcm4.js";const I=p.default??p,E=I(globalThis.navigator),H=9,_=100,C=0,$=0,g=2,f=1,O=-1e3,k=-1e3,A=2;class x{constructor(e,t=E){this._mobileInfo=t,this.debug=!1,this._isActive=!1,this._isMobileAccessibility=!1,this._pool=[],this._renderId=0,this._children=[],this._androidUpdateCount=0,this._androidUpdateFrequency=500,this._hookDiv=null,(t.tablet||t.phone)&&this._createTouchHook();const l=document.createElement("div");l.style.width=`${_}px`,l.style.height=`${_}px`,l.style.position="absolute",l.style.top=`${C}px`,l.style.left=`${$}px`,l.style.zIndex=g.toString(),this._div=l,this._renderer=e,this._onKeyDown=this._onKeyDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),globalThis.addEventListener("keydown",this._onKeyDown,!1)}get isActive(){return this._isActive}get isMobileAccessibility(){return this._isMobileAccessibility}get hookDiv(){return this._hookDiv}_createTouchHook(){const e=document.createElement("button");e.style.width=`${f}px`,e.style.height=`${f}px`,e.style.position="absolute",e.style.top=`${O}px`,e.style.left=`${k}px`,e.style.zIndex=A.toString(),e.style.backgroundColor="#FF0000",e.title="select to enable accessibility for this content",e.addEventListener("focus",()=>{this._isMobileAccessibility=!0,this._activate(),this._destroyTouchHook()}),document.body.appendChild(e),this._hookDiv=e}_destroyTouchHook(){this._hookDiv&&(document.body.removeChild(this._hookDiv),this._hookDiv=null)}_activate(){var e;this._isActive||(this._isActive=!0,globalThis.document.addEventListener("mousemove",this._onMouseMove,!0),globalThis.removeEventListener("keydown",this._onKeyDown,!1),this._renderer.runners.postrender.add(this),(e=this._renderer.view.canvas.parentNode)==null||e.appendChild(this._div))}_deactivate(){var e;!this._isActive||this._isMobileAccessibility||(this._isActive=!1,globalThis.document.removeEventListener("mousemove",this._onMouseMove,!0),globalThis.addEventListener("keydown",this._onKeyDown,!1),this._renderer.runners.postrender.remove(this),(e=this._div.parentNode)==null||e.removeChild(this._div))}_updateAccessibleObjects(e){if(!e.visible||!e.accessibleChildren)return;e.accessible&&e.isInteractive()&&(e._accessibleActive||this._addChild(e),e._renderId=this._renderId);const t=e.children;if(t)for(let l=0;l<t.length;l++)this._updateAccessibleObjects(t[l])}init(e){this.debug=(e==null?void 0:e.debug)??this.debug,this._renderer.runners.postrender.remove(this)}postrender(){const e=performance.now();if(this._mobileInfo.android.device&&e<this._androidUpdateCount||(this._androidUpdateCount=e+this._androidUpdateFrequency,!this._renderer.renderingToScreen||!this._renderer.view.canvas))return;this._renderer.lastObjectRendered&&this._updateAccessibleObjects(this._renderer.lastObjectRendered);const{x:t,y:l,width:r,height:b}=this._renderer.view.canvas.getBoundingClientRect(),{width:c,height:u,resolution:v}=this._renderer,h=r/c*v,a=b/u*v;let i=this._div;i.style.left=`${t}px`,i.style.top=`${l}px`,i.style.width=`${c}px`,i.style.height=`${u}px`;for(let d=0;d<this._children.length;d++){const s=this._children[d];if(s._renderId!==this._renderId)s._accessibleActive=!1,m(this._children,d,1),this._div.removeChild(s._accessibleDiv),this._pool.push(s._accessibleDiv),s._accessibleDiv=null,d--;else{i=s._accessibleDiv;let n=s.hitArea;const o=s.worldTransform;s.hitArea?(i.style.left=`${(o.tx+n.x*o.a)*h}px`,i.style.top=`${(o.ty+n.y*o.d)*a}px`,i.style.width=`${n.width*o.a*h}px`,i.style.height=`${n.height*o.d*a}px`):(n=s.getBounds().rectangle,this._capHitArea(n),i.style.left=`${n.x*h}px`,i.style.top=`${n.y*a}px`,i.style.width=`${n.width*h}px`,i.style.height=`${n.height*a}px`,i.title!==s.accessibleTitle&&s.accessibleTitle!==null&&(i.title=s.accessibleTitle||""),i.getAttribute("aria-label")!==s.accessibleHint&&s.accessibleHint!==null&&i.setAttribute("aria-label",s.accessibleHint||"")),(s.accessibleTitle!==i.title||s.tabIndex!==i.tabIndex)&&(i.title=s.accessibleTitle||"",i.tabIndex=s.tabIndex,this.debug&&this._updateDebugHTML(i))}}this._renderId++}_updateDebugHTML(e){e.innerHTML=`type: ${e.type}</br> title : ${e.title}</br> tabIndex: ${e.tabIndex}`}_capHitArea(e){e.x<0&&(e.width+=e.x,e.x=0),e.y<0&&(e.height+=e.y,e.y=0);const{width:t,height:l}=this._renderer;e.x+e.width>t&&(e.width=t-e.x),e.y+e.height>l&&(e.height=l-e.y)}_addChild(e){let t=this._pool.pop();t||(t=document.createElement("button"),t.style.width=`${_}px`,t.style.height=`${_}px`,t.style.backgroundColor=this.debug?"rgba(255,255,255,0.5)":"transparent",t.style.position="absolute",t.style.zIndex=g.toString(),t.style.borderStyle="none",navigator.userAgent.toLowerCase().includes("chrome")?t.setAttribute("aria-live","off"):t.setAttribute("aria-live","polite"),navigator.userAgent.match(/rv:.*Gecko\//)?t.setAttribute("aria-relevant","additions"):t.setAttribute("aria-relevant","text"),t.addEventListener("click",this._onClick.bind(this)),t.addEventListener("focus",this._onFocus.bind(this)),t.addEventListener("focusout",this._onFocusOut.bind(this))),t.style.pointerEvents=e.accessiblePointerEvents,t.type=e.accessibleType,e.accessibleTitle&&e.accessibleTitle!==null?t.title=e.accessibleTitle:(!e.accessibleHint||e.accessibleHint===null)&&(t.title=`container ${e.tabIndex}`),e.accessibleHint&&e.accessibleHint!==null&&t.setAttribute("aria-label",e.accessibleHint),this.debug&&this._updateDebugHTML(t),e._accessibleActive=!0,e._accessibleDiv=t,t.container=e,this._children.push(e),this._div.appendChild(e._accessibleDiv),e._accessibleDiv.tabIndex=e.tabIndex}_dispatchEvent(e,t){const{container:l}=e.target,r=this._renderer.events.rootBoundary,b=Object.assign(new w(r),{target:l});r.rootTarget=this._renderer.lastObjectRendered,t.forEach(c=>r.dispatchEvent(b,c))}_onClick(e){this._dispatchEvent(e,["click","pointertap","tap"])}_onFocus(e){e.target.getAttribute("aria-live")||e.target.setAttribute("aria-live","assertive"),this._dispatchEvent(e,["mouseover"])}_onFocusOut(e){e.target.getAttribute("aria-live")||e.target.setAttribute("aria-live","polite"),this._dispatchEvent(e,["mouseout"])}_onKeyDown(e){e.keyCode===H&&this._activate()}_onMouseMove(e){e.movementX===0&&e.movementY===0||this._deactivate()}destroy(){this._destroyTouchHook(),this._div=null,globalThis.document.removeEventListener("mousemove",this._onMouseMove,!0),globalThis.removeEventListener("keydown",this._onKeyDown),this._pool=null,this._children=null,this._renderer=null}}x.extension={type:[y.WebGLSystem,y.WebGPUSystem],name:"accessibility"};const M={accessible:!1,accessibleTitle:null,accessibleHint:null,tabIndex:0,_accessibleActive:!1,_accessibleDiv:null,accessibleType:"button",accessiblePointerEvents:"auto",accessibleChildren:!0,_renderId:-1};T.add(x);D.mixin(M);
